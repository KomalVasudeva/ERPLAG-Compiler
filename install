#! /bin/bash

BOLD='\033[1m'
GREEN='\033[1;32m'
CYAN='\033[1;36m'
RED='\033[1;31m'
RESET='\033[0m'

spin()
{
  while :
  do
    sleep 5
    printf ".\n"
  done
}


installErr () {
	printf "\n${BOLD}${RED}ERPLAG compiler installation failed. \nPlease export repository directory to PATH variable.${RESET}\n"
	printf "Press enter to continue..."
	read
}

if [ -f /usr/local/bin/erplag ]
then
	printf "${BOLD}${GREEN}ERPLAG compiler is already installed in this system${RESET}\n\n" 
	printf "Please use ${BOLD}${CYAN}./rebuild ${RESET}to quickly remake the compiler\n"
	printf "Otherwise, use ${BOLD}${CYAN}./uninstall ${RESET} to uninstall the compiler\n"

	exit
fi

sudo printf "Installing ERPLAG compiler... \n"


if [[ "$OSTYPE" == "linux-gnu"* ]]
then
	if [ -f /etc/os-release ]; then
	    # freedesktop.org and systemd
	    . /etc/os-release
	    OS=$NAME
	    TYPE=$ID_LIKE
	fi

	if [[ "$TYPE" == "debian" ]] 
	then
		sudo apt-get update
		sudo apt-get install build-essential
		sudo apt-get install nasm
	elif [[ "$TYPE" == "rhel fedora" ]] 
	then
		sudo yum install gcc
		sudo yum install make
		sudo yum install wget
		wget https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/linux/nasm-2.14.02-0.fc27.x86_64.rpm
		sudo yum install nasm-2.14.02-0.fc27.x86_64.rpm
		rm -f nasm-2.14.02-0.fc27.x86_64.rpm
	fi	
elif [[ "$OSTYPE" == "darwin"* ]]
then
	var=$(sudo which brew) 
	if test "$var" == ""
	then
		/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
	fi

	spin &
	SPIN_PID=$!
	brew update
	kill -9 $SPIN_PID
	wait $SPIN_PID 2>/dev/null

	spin &
	SPIN_PID=$!
	brew install gcc
	kill -9 $SPIN_PID
	wait $SPIN_PID 2>/dev/null

	spin &
	SPIN_PID=$!
	brew install make
	kill -9 $SPIN_PID
	wait $SPIN_PID 2>/dev/null

	spin &
	SPIN_PID=$!
	brew install nasm
	kill -9 $SPIN_PID
	wait $SPIN_PID 2>/dev/null
else
    printf "${BOLD}${RED}ERPLAG compiler has not been designed for this OS. Please use a 64-bit linux distribution, macOS or Windows OS.${RESET}\n"
    printf "Press enter to continue..."
	read
    exit
fi

make

sudo cp erplag /usr/local/bin
stat=$?
if [ $stat -ne 0 ]
then
	installErr 
	exit
fi

sudo cp .compiler /usr/local/bin
stat=$?
if [ $stat -ne 0 ]
then
	installErr 
	exit
fi

sudo cp erpclr /usr/local/bin
stat=$?
if [ $stat -ne 0 ]
then
	installErr 
	exit
fi

make clean

printf "\n${BOLD}${GREEN}ERPLAG compiler has been successfully installed!${RESET}\n"
printf "Use ${BOLD}${CYAN}erplag -h ${RESET}to read the guidelines for using the compiler\n"
printf "\nPress enter to continue..."
read
